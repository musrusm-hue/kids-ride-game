<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í–µ—Å–µ–ª–∞—è –ø–æ–µ–∑–¥–∫–∞: MUSIC & SOUNDS</title>
    <style>
        :root {
            --sky: #7ad8d0;
            --road: #95a5a6;
            --pink: #ff9ecd;
            --yellow: #ffdf6b;
            --white: #ffffff;
            --font: 'Comic Sans MS', 'Chalkboard SE', cursive;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font);
            background: var(--sky);
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            position: fixed;
            width: 100%;
            touch-action: none;
            transition: filter 2s ease;
        }

        .night-mode {
            filter: brightness(0.4) contrast(1.2);
        }

        #game-stage {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--sky);
            overflow: hidden;
            transition: background 3s ease;
        }

        @keyframes shake {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            60% {
                transform: translate(-3px, 1px) rotate(0deg);
            }

            70% {
                transform: translate(3px, 1px) rotate(-1deg);
            }

            80% {
                transform: translate(-1px, -1px) rotate(1deg);
            }

            90% {
                transform: translate(1px, 2px) rotate(0deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        .shake {
            animation: shake 0.5s;
        }

        #road {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 100%;
            background: var(--road);
            border-left: 8px solid var(--white);
            border-right: 8px solid var(--white);
        }

        #road::after {
            content: '';
            position: absolute;
            left: 50%;
            width: 6px;
            height: 100%;
            background: repeating-linear-gradient(0deg, #fff, #fff 50px, transparent 50px, transparent 100px);
            animation: road-flow 0.6s linear infinite;
        }

        @keyframes road-flow {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(100px);
            }
        }

        #player {
            position: absolute;
            bottom: 15%;
            left: 50%;
            width: 90px;
            height: 130px;
            background: var(--pink);
            border-radius: 25px;
            transform: translateX(-50%);
            z-index: 100;
            box-shadow: 0 10px 0 #cc7eab, 0 20px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 15px;
            will-change: left;
        }

        #player.shielded {
            outline: 6px solid #3498db;
            outline-offset: 4px;
            box-shadow: 0 0 30px #3498db;
        }

        #player-window {
            width: 70px;
            height: 70px;
            background: #eee;
            border: 6px solid var(--white);
            border-radius: 50%;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        #player-window img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #player::after,
        #player::before {
            content: '';
            position: absolute;
            bottom: -5px;
            width: 15px;
            height: 15px;
            background: var(--yellow);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--yellow);
        }

        #player::after {
            left: 10px;
        }

        #player::before {
            right: 10px;
        }

        .game-object {
            position: absolute;
            font-size: 3rem;
            transform: translate(-50%, -50%);
            z-index: 50;
            filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.2));
        }

        .police {
            font-size: 3.5rem;
            z-index: 60;
        }

        #fog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.8), transparent);
            pointer-events: none;
            z-index: 500;
            opacity: 0;
            transition: opacity 2s;
        }

        #hud {
            position: fixed;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 1000;
        }

        .hud-item {
            background: var(--white);
            padding: 8px 12px;
            border-radius: 30px;
            font-weight: 900;
            font-size: 1rem;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 5px;
            color: #ff6b81;
        }

        #sound-btn {
            background: #fff;
            cursor: pointer;
            border: none;
        }

        #combo-tag {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            font-weight: 900;
            color: #f1c40f;
            text-shadow: 0 2px 0 #000;
            display: none;
            white-space: nowrap;
        }

        #energy-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 25px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            border: 4px solid var(--white);
            overflow: hidden;
        }

        #energy-fill {
            width: 100%;
            height: 100%;
            background: #2ecc71;
            transition: width 0.3s, background 0.5s;
        }

        .flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--sky);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            text-align: center;
        }

        .btn-big {
            padding: 20px 50px;
            background: #ff4757;
            color: #fff;
            border: none;
            border-radius: 50px;
            font-size: 2rem;
            font-weight: 900;
            box-shadow: 0 10px 0 #cc3a47;
            cursor: pointer;
            margin-top: 30px;
        }

        .btn-big:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #cc3a47;
        }
    </style>
</head>

<body>
    <div id="hud">
        <div class="hud-item">‚≠ê <span id="val-score">0</span></div>
        <div class="hud-item">üç≠ <span id="val-energy">100</span></div>
        <div class="hud-item">üöÄ x<span id="val-speed">1.0</span></div>
        <button id="sound-btn" class="hud-item" onclick="toggleSound()">üîâ</button>
    </div>

    <div id="game-stage">
        <div id="fog"></div>
        <div id="road"></div>
        <div id="player">
            <div id="combo-tag">COMBO x2!</div>
            <div id="player-window">
                <img src="–¥–µ—Ç–∏.jpeg" alt="–î–µ—Ç–∏">
            </div>
            <div style="font-size: 0.8rem; font-weight: bold; color: white; margin-top: 2px;">VROOM!</div>
        </div>
    </div>

    <div id="energy-bar">
        <div id="energy-fill"></div>
    </div>

    <div id="start-overlay" class="overlay">
        <h1 style="font-size: 3rem; color: #fff; text-shadow: 0 5px 0 rgba(0,0,0,0.1);">SOUND & TRACKS! üé∂</h1>
        <img src="–¥–µ—Ç–∏.jpeg"
            style="width: 150px; height: 150px; border-radius: 50%; border: 8px solid #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.2);">
        <p style="color: #fff; font-size: 1.5rem; margin-top: 20px;">
            –ù–æ–≤—ã–µ –∑–≤—É–∫–∏ –º–æ—Ç–æ—Ä–∞! üîä<br>
            –í–µ—Å–µ–ª–∞—è –º—É–∑—ã–∫–∞! üéπ<br>
            –ì–∞–∑—É–π –ø–æ –ø–æ–ª–Ω–æ–π! üî•
        </p>
        <button class="btn-big" onclick="startGame()">–ì–û–ù–ö–ê! üèÅ</button>
    </div>

    <div id="flash-screen" class="flash"></div>

    <script>
        // --- AUDIO ENGINE ---
        const AudioEngine = {
            ctx: null,
            master: null,
            soundOn: false,
            engineOsc: null,
            engineGain: null,
            musicTimer: null,

            init() {
                if (this.ctx) return;
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.master = this.ctx.createGain();
                this.master.connect(this.ctx.destination);
                this.master.gain.value = 0.5;
            },

            playSFX(freq, type = 'sine', duration = 0.1, slide = 0) {
                if (!this.soundOn || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                if (slide) osc.frequency.exponentialRampToValueAtTime(slide, this.ctx.currentTime + duration);
                g.gain.setValueAtTime(0.3, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(g);
                g.connect(this.master);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },

            playCrash() {
                if (!this.soundOn || !this.ctx) return;
                const bufferSize = this.ctx.sampleRate * 0.2;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 400;
                noise.connect(filter);
                filter.connect(this.master);
                noise.start();
            },

            startEngine() {
                if (!this.soundOn || !this.ctx || this.engineOsc) return;
                this.engineOsc = this.ctx.createOscillator();
                this.engineOsc.type = 'triangle';
                this.engineGain = this.ctx.createGain();
                this.engineGain.gain.value = 0.05;
                this.engineOsc.connect(this.engineGain);
                this.engineGain.connect(this.master);
                this.engineOsc.start();
            },

            updateEngine(speedMult) {
                if (this.engineOsc) {
                    this.engineOsc.frequency.setTargetAtTime(40 + (speedMult * 20), this.ctx.currentTime, 0.1);
                }
            },

            stopEngine() {
                if (this.engineOsc) { this.engineOsc.stop(); this.engineOsc = null; }
            },

            playMusicStep() {
                const notes = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00];
                const note = notes[Math.floor(Math.random() * notes.length)];
                this.playSFX(note, 'square', 0.15, note / 2);
            }
        };

        function toggleSound() {
            AudioEngine.init();
            AudioEngine.soundOn = !AudioEngine.soundOn;
            document.getElementById('sound-btn').textContent = AudioEngine.soundOn ? 'üîâ' : 'üîá';
            if (AudioEngine.soundOn && state.active) {
                AudioEngine.startEngine();
                AudioEngine.musicTimer = setInterval(() => AudioEngine.playMusicStep(), 200);
            } else {
                AudioEngine.stopEngine();
                clearInterval(AudioEngine.musicTimer);
            }
        }

        // --- GAME LOGIC ---
        let state = {
            active: false,
            score: 0,
            energy: 100,
            baseSpeed: 6,
            speedMult: 1,
            playerX: 50,
            distance: 0,
            combo: 0,
            shield: false,
            magnet: 0,
            night: false
        };

        const el = {
            stage: document.getElementById('game-stage'),
            player: document.getElementById('player'),
            score: document.getElementById('val-score'),
            energy: document.getElementById('val-energy'),
            energyFill: document.getElementById('energy-fill'),
            flash: document.getElementById('flash-screen'),
            speed: document.getElementById('val-speed'),
            combo: document.getElementById('combo-tag'),
            fog: document.getElementById('fog')
        };

        let isDragging = false;
        function updatePlayerPos(clientX) {
            if (!state.active) return;
            const stageRect = el.stage.getBoundingClientRect();
            let xPercent = ((clientX - stageRect.left) / stageRect.width) * 100;
            state.playerX = Math.max(15, Math.min(85, xPercent));
            el.player.style.left = state.playerX + '%';
        }

        el.stage.addEventListener('mousedown', (e) => { isDragging = true; updatePlayerPos(e.clientX); });
        window.addEventListener('mousemove', (e) => { if (isDragging) updatePlayerPos(e.clientX); });
        window.addEventListener('mouseup', () => { isDragging = false; });
        el.stage.addEventListener('touchstart', (e) => { isDragging = true; updatePlayerPos(e.touches[0].clientX); }, { passive: false });
        el.stage.addEventListener('touchmove', (e) => { if (isDragging) { e.preventDefault(); updatePlayerPos(e.touches[0].clientX); } }, { passive: false });
        el.stage.addEventListener('touchend', () => { isDragging = false; });

        function startGame() {
            document.getElementById('start-overlay').style.display = 'none';
            state.active = true;
            if (AudioEngine.soundOn) {
                AudioEngine.startEngine();
                AudioEngine.musicTimer = setInterval(() => AudioEngine.playMusicStep(), 200);
            }
            gameLoop();
            spawnLoop();
        }

        function gameLoop() {
            if (!state.active) return;
            state.distance++;
            state.energy -= 0.04;
            state.speedMult = 1 + (state.distance / 5000);
            AudioEngine.updateEngine(state.speedMult);
            updateEnvironment();
            if (state.energy <= 0) endGame();
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function updateEnvironment() {
            const cycle = Math.floor(state.distance / 1500) % 2;
            if (cycle === 1 && !state.night) {
                state.night = true;
                document.body.classList.add('night-mode');
                el.fog.style.opacity = '1';
                AudioEngine.playSFX(200, 'square', 0.5, 100); // –ì—É–ª –Ω–æ—á–∏
            } else if (cycle === 0 && state.night) {
                state.night = false;
                document.body.classList.remove('night-mode');
                el.fog.style.opacity = '0';
            }
            const worldIndex = Math.floor(state.distance / 1000) % 4;
            const colors = ['#7ad8d0', '#ff9ecd', '#ffdf6b', '#a9e4ef'];
            el.stage.style.background = colors[worldIndex];
        }

        function updateUI() {
            el.score.textContent = Math.floor(state.score);
            el.energy.textContent = Math.ceil(state.energy);
            el.speed.textContent = state.speedMult.toFixed(1);
            el.energyFill.style.width = state.energy + '%';
            if (state.energy < 30) el.energyFill.style.background = '#e74c3c';
            else el.energyFill.style.background = '#2ecc71';
            if (state.shield) el.player.classList.add('shielded');
            else el.player.classList.remove('shielded');
            if (state.combo > 2) {
                el.combo.style.display = 'block';
                el.combo.textContent = `COMBO x${state.combo}!`;
            } else { el.combo.style.display = 'none'; }
        }

        function spawnLoop() {
            if (!state.active) return;
            const roll = Math.random();
            if (roll < 0.4) createObj('‚≠ê');
            else if (roll < 0.6) createObj('üç≠');
            else if (roll < 0.8) createObj('üöß');
            else if (roll < 0.9) createObj('üöì');
            else if (roll < 0.95) createObj('üõ°Ô∏è');
            else createObj('üß≤');
            const delay = Math.max(250, 1000 / state.speedMult);
            setTimeout(spawnLoop, delay);
        }

        function createObj(type) {
            const obj = document.createElement('div');
            obj.className = 'game-object' + (type === 'üöì' ? ' police' : '');
            obj.innerHTML = type;
            const startX = 15 + Math.random() * 70;
            obj.style.left = startX + '%';
            obj.style.top = '-100px';
            el.stage.appendChild(obj);
            let top = -100;
            const currentObjSpeed = (type === 'üöì' ? 12 : 6) * state.speedMult;
            const moveObj = () => {
                if (!state.active) { obj.remove(); return; }
                if (state.magnet > 0 && (type === '‚≠ê' || type === 'üç≠')) {
                    const lPos = parseFloat(obj.style.left);
                    const dx = state.playerX - lPos;
                    obj.style.left = (lPos + dx * 0.1) + '%';
                }
                top += currentObjSpeed;
                obj.style.top = top + 'px';
                if (top > window.innerHeight * 0.7 && top < window.innerHeight * 0.88) {
                    const dist = Math.abs(parseFloat(obj.style.left) - state.playerX);
                    if (dist < 12) { collect(type); obj.remove(); return; }
                }
                if (top < window.innerHeight + 100) requestAnimationFrame(moveObj);
                else { if (type === '‚≠ê') state.combo = 0; obj.remove(); }
            };
            requestAnimationFrame(moveObj);
        }

        function collect(type) {
            if (type === '‚≠ê') {
                state.combo++;
                state.score += 10 * Math.min(5, state.combo);
                AudioEngine.playSFX(600 + (state.combo * 50), 'sine', 0.1, 800);
                flashEffect('#ffdf6b');
            } else if (type === 'üç≠') {
                state.energy = Math.min(100, state.energy + 10);
                AudioEngine.playSFX(400, 'sine', 0.2, 600);
                flashEffect('#2ecc71');
            } else if (type === 'üöß' || type === 'üöì') {
                if (state.shield) {
                    state.shield = false;
                    AudioEngine.playSFX(200, 'square', 0.3, 50);
                    flashEffect('#3498db');
                } else {
                    state.energy -= 25;
                    state.combo = 0;
                    document.body.classList.add('shake');
                    setTimeout(() => document.body.classList.remove('shake'), 500);
                    AudioEngine.playCrash();
                    flashEffect('#e74c3c');
                }
            } else if (type === 'üõ°Ô∏è') {
                state.shield = true;
                AudioEngine.playSFX(300, 'sawtooth', 0.4, 600);
                flashEffect('#3498db');
            } else if (type === 'üß≤') {
                state.magnet = 500;
                AudioEngine.playSFX(200, 'sine', 0.5, 1000);
                flashEffect('#9b59b6');
                const magTimer = setInterval(() => {
                    state.magnet--;
                    if (state.magnet <= 0) clearInterval(magTimer);
                }, 20);
            }
        }

        function flashEffect(color) {
            el.flash.style.background = color;
            el.flash.style.opacity = '0.3';
            setTimeout(() => el.flash.style.opacity = '0', 100);
        }

        function endGame() {
            state.active = false;
            AudioEngine.stopEngine();
            clearInterval(AudioEngine.musicTimer);
            document.body.classList.remove('night-mode');
            document.body.innerHTML = `
                <div class="overlay" style="background: #ff4757">
                    <h1 style="color:white; font-size:3rem;">–ú–´ –ü–†–ò–ï–•–ê–õ–ò! üí•</h1>
                    <div style="font-size: 5rem;">üöú</div>
                    <h2 style="color:white">–¢–≤–æ–π —Å—á—ë—Ç: ${Math.floor(state.score)}</h2>
                    <p style="color:white; font-size:1.2rem;">–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${Math.floor(state.distance)}–º</p>
                    <button class="btn-big" onclick="location.reload()">–ï–©–Å –†–ê–ó! üöóüí®</button>
                </div>
            `;
            if (AudioEngine.soundOn) AudioEngine.playSFX(100, 'sawtooth', 1, 50);
        }
    </script>
</body>

</html>